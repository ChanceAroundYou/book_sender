# Book Sender 部署文档

## 1. Docker部署

### 1.1 环境要求
- Docker 20.10+
- Docker Compose 2.0+
- 4GB+ RAM
- 20GB+ 磁盘空间

### 1.2 目录结构
项目采用标准的Docker部署结构，包含以下主要目录：
- docker/：存放Docker相关配置文件
- app/：应用程序代码
- docs/：项目文档
- .env：环境变量配置文件

### 1.3 Dockerfile说明
Dockerfile采用Python 3.12作为基础镜像，主要配置包括：
- 设置工作目录为/app
- 配置Python环境变量
- 安装必要的系统依赖（build-essential、curl、libpq-dev等）
- 复制项目文件到容器中
- 安装Python依赖
- 配置应用启动命令

### 1.4 docker-compose服务说明
项目包含以下主要服务：

1. PostgreSQL数据库服务
   - 使用PostgreSQL 15版本
   - 配置数据持久化
   - 设置健康检查
   - 暴露5432端口

2. Redis缓存服务
   - 使用Redis 7版本
   - 启用数据持久化
   - 配置健康检查
   - 暴露6379端口

3. FastAPI应用服务
   - 构建自定义镜像
   - 配置应用卷挂载
   - 设置环境变量
   - 依赖数据库和Redis服务
   - 暴露8000端口

4. Celery Worker服务
   - 用于处理异步任务
   - 配置与主应用相同的环境
   - 支持文件下载功能

5. Celery Beat服务
   - 用于处理定时任务
   - 配置与主应用相同的环境

### 1.5 环境变量配置
项目需要配置以下环境变量：

1. 数据库配置
   - 数据库用户名
   - 数据库密码
   - 数据库名称

2. Redis配置
   - Redis主机地址
   - Redis端口

3. 应用配置
   - 密钥配置
   - API版本前缀

4. AWS配置（如使用）
   - 访问密钥
   - 密钥ID
   - 区域设置
   - S3存储桶配置

5. 邮件配置
   - SMTP服务器设置
   - 邮件账号配置
   - 发件人信息

## 2. 部署步骤

### 2.1 准备工作
1. 确保Docker和Docker Compose已正确安装
2. 克隆项目代码到本地
3. 根据.env.example创建并配置.env文件

### 2.2 构建和启动
1. 构建Docker镜像
2. 启动所有服务
3. 监控服务日志

### 2.3 数据库迁移
1. 进入应用容器
2. 执行数据库迁移命令
3. 验证迁移结果

### 2.4 健康检查
1. 检查所有服务状态
2. 验证应用日志
3. 测试数据库连接

## 3. 生产环境配置

### 3.1 Nginx配置
配置Nginx作为反向代理，主要设置包括：
- 监听80端口
- 配置SSL证书（如需要）
- 设置代理规则
- 配置安全头部

### 3.2 SSL配置
如需要HTTPS支持，需要：
- 申请SSL证书
- 配置证书路径
- 设置SSL参数
- 配置强制HTTPS

## 4. 监控和维护

### 4.1 日志管理
- 实现集中式日志收集
- 配置日志轮转策略
- 设置日志告警规则
- 定期日志分析

### 4.2 性能监控
- 部署监控系统
- 配置性能指标收集
- 设置监控面板
- 配置告警规则

### 4.3 备份策略
- 定期数据库备份
- 配置文件备份
- 测试恢复流程
- 制定备份计划

## 5. 故障处理

### 5.1 常见问题
- 数据库连接问题
- Redis连接问题
- Celery任务异常
- 文件上传失败

### 5.2 故障恢复
- 服务重启流程
- 数据恢复流程
- 配置恢复流程
- 应急响应计划

## 6. 安全建议

### 6.1 网络安全
- 配置防火墙规则
- 启用HTTPS加密
- 限制端口访问
- 实施访问控制

### 6.2 数据安全
- 加密敏感数据
- 定期更新密钥
- 审计数据访问
- 实施数据备份

### 6.3 应用安全
- 更新依赖包
- 扫描安全漏洞
- 实施访问控制
- 定期安全审计 